/* jQuery Bracket | Copyright (c) Teijo Laine 2011-2016 | Licenced under the MIT licence */
!function(a){function b(a){return!isNaN(parseFloat(a))&&isFinite(a)}function c(){this.message="Root of information for this team",this.name="EndOfBranchException"}function d(a){function b(a,c){return a instanceof Array?b(a[0],c+1):c}return b(a,0)}function e(a,b){return b>0&&(a=e([a],b-1)),a}function f(b,c,d){var e=d.find(".team[data-teamid="+b+"]"),f=c?c:"highlight";return{highlight:function(){e.each(function(){a(this).addClass(f),a(this).hasClass("win")&&a(this).parent().find(".connector").addClass(f)})},deHighlight:function(){e.each(function(){a(this).removeClass(f),a(this).parent().find(".connector").removeClass(f)})}}}function g(b,c,d){var e=d||c,g=e.winner(),h=e.loser();g&&h&&(g.name.isEmpty()||f(g.idx,"highlightWinner",b).highlight(),h.name.isEmpty()||f(h.idx,"highlightLoser",b).highlight()),b.find(".team").mouseover(function(){var c=parseInt(a(this).attr("data-teamid"),10);if(c!==-1){var d=f(c,null,b);d.highlight(),a(this).mouseout(function(){d.deHighlight(),a(this).unbind("mouseout")})}})}function h(b,c,d){var e=a('<input type="text">');e.val(c),b.empty().append(e),e.focus(),e.blur(function(){d(e.val())}),e.keydown(function(a){var b=a.keyCode||a.which;9!==b&&13!==b&&27!==b||(a.preventDefault(),d(e.val(),27!==b))})}function i(a,b,c){a.append(b)}function j(a){var b=a.el,c=b.find(".team.win");c.append('<div class="bubble">1st</div>');var d=b.find(".team.lose");return d.append('<div class="bubble">2nd</div>'),!0}function k(a){var b=a.el,c=b.find(".team.win");c.append('<div class="bubble third">3rd</div>');var d=b.find(".team.lose");return d.append('<div class="bubble fourth">4th</div>'),!0}function l(a,b,c,d,e){for(var f,g=Math.log(2*b.length)/Math.log(2),h=b.length,i=0;i<g;i+=1){f=a.addRound();for(var l=0;l<h;l+=1){var m=0===i?x(b,l):null;if(i===g-1&&c||i===g-1&&e){var n=f.addMatch(m,j);e||n.setAlignCb(y(n,d))}else f.addMatch(m)}h/=2}if(c&&(a.final().connectorCb(function(){return null}),b.length>1&&!d)){var o=a.final().round().prev(),p=o.map(function(a){return a.match(0).loser}).toNull(),q=o.map(function(a){return a.match(1).loser}).toNull(),r=f.addMatch(function(){return[{source:p},{source:q}]},k);r.setAlignCb(function(b){var c=a.el.height()/2;r.el.css("height",c+"px");var d=b.height();b.css("top",d+"px")}),r.connectorCb(function(){return null})}}function m(a,b,c,d){for(var e=Math.log(2*c)/Math.log(2)-1,f=c/2,g=0;g<e;g+=1){for(var h=d&&g===e-1?1:2,i=0;i<h;i+=1)for(var j=b.addRound(),l=0;l<f;l+=1){var m=i%2!==0||0===g?z(a,b,f,l,i,g):null,n=g===e-1&&d,o=j.addMatch(m,n?k:null);if(o.setAlignCb(A(o.el.find(".teamContainer"),o)),n)o.connectorCb(function(){return null});else if(g<e-1||i<1){var p=i%2===0?function(a,b){var c=a.height()/4,d=0,e=0;return 0===b.winner().id?e=c:1===b.winner().id?(d=2*-c,e=c):e=2*c,{height:d,shift:e}}:null;o.connectorCb(p)}}f/=2}}function n(a,b,c,d,e,f){var g=a.addRound(),h=g.addMatch(function(){return[{source:b.winner},{source:c.winner}]},function(e){var g=!1;if(d||e.winner().name.isEmpty()||e.winner().name!==c.winner().name)return j(e);if(2===a.size())return!1;var h=a.addRound(function(){var b=!e.winner().name.isEmpty()&&e.winner().name===c.winner().name;return g===!1&&b&&(g=!0,f.css("width",parseInt(f.css("width"),10)+140+"px")),!b&&g&&(g=!1,a.dropRound(),f.css("width",parseInt(f.css("width"),10)-140+"px")),b}),i=h.addMatch(function(){return[{source:e.first},{source:e.second}]},j);return e.connectorCb(function(a){return{height:0,shift:a.height()/2}}),i.connectorCb(function(){return null}),i.setAlignCb(function(a){var d=b.el.height()+c.el.height();i.el.css("height",d+"px");var e=(b.el.height()/2+b.el.height()+c.el.height()/2)/2-a.height();a.css("top",e+"px")}),!1});if(h.setAlignCb(function(a){var d=b.el.height()+c.el.height();e||(d/=2),h.el.css("height",d+"px");var f=(b.el.height()/2+b.el.height()+c.el.height()/2)/2-a.height();a.css("top",f+"px")}),!e){var i=c.final().round().prev(),l=g.addMatch(function(){return[{source:i.get().match(0).loser},{source:c.loser}]},k);l.setAlignCb(function(a){var d=(b.el.height()+c.el.height())/2;l.el.css("height",d+"px");var e=(b.el.height()/2+b.el.height()+c.el.height()/2)/2+a.height()/2-d;a.css("top",e+"px")}),h.connectorCb(function(){return null}),l.connectorCb(function(){return null})}b.final().connectorCb(function(a){var d,e,f=a.height()/4,g=(b.el.height()/2+b.el.height()+c.el.height()/2)/2-a.height()/2,h=g-b.el.height()/2;return 0===b.winner().id?(e=h+2*f,d=f):1===b.winner().id?(e=h,d=3*f):(e=h+f,d=2*f),e-=a.height()/2,{height:e,shift:d}}),c.final().connectorCb(function(a){var d,e,f=a.height()/4,g=(b.el.height()/2+b.el.height()+c.el.height()/2)/2-a.height()/2,h=g-b.el.height()/2;return 0===c.winner().id?(e=h,d=3*f):1===c.winner().id?(e=h+2*f,d=f):(e=h+f,d=2*f),e+=a.height()/2,{height:-e,shift:-d}})}function o(a,b,c,d){var e=[];return{el:a,addRound:function(a){var f=e.length,g=f>0?e[f-1]:null,h=b.map(function(a){return void 0===a[f]?null:a[f]}),i=new B(this,u.of(g),f,h,a,c,d);return e.push(i),i},dropRound:function(){e.pop()},round:function(a){return e[a]},size:function(){return e.length},final:function(){return e[e.length-1].match(0)},winner:function(){return e[e.length-1].match(0).winner()},loser:function(){return e[e.length-1].match(0).loser()},render:function(){a.empty();for(var b=0;b<e.length;b+=1)e[b].render()},results:function(){return e.reduce(function(a,b){return a.concat([b.results()])},[])}}}function p(b,c,d,e){var f=parseInt(a(".round:first").css("margin-right"),10)/2,g=!0;b<0&&(g=!1,b=-b),b<2&&(b=0);var h=a('<div class="connector"></div>').appendTo(d);h.css("height",b),h.css("width",f+"px"),h.css(e,-f-2+"px"),c>=0?h.css("top",c+"px"):h.css("bottom",-c+"px"),g?h.css("border-bottom","none"):h.css("border-top","none");var i=a('<div class="connector"></div>').appendTo(h);return i.css("width",f+"px"),i.css(e,-f+"px"),g?i.css("bottom","0px"):i.css("top","0px"),h}function q(a,b,c){return b?Math.log(2*a)/Math.log(2):c?Math.max(2,2*(Math.log(2*a)/Math.log(2)-1)-1):2*(Math.log(2*a)/Math.log(2)-1)+1}function r(b){var c=a.extend(!0,{},b);return c.teams=c.teams.map(function(a){return a.map(function(a){return a.toNull()})}),c}function s(b,c,d){var e=a('<div class="tools"></div>').appendTo(b),f=a('<span class="increment">+</span>').appendTo(e);if(f.click(function(){for(var a=c.teams.length,b=0;b<a;b+=1)c.teams.push([u.of(null),u.of(null)]);return C(d)}),c.teams.length>1&&1===c.results.length||c.teams.length>2&&3===c.results.length){var g=a('<span class="decrement">-</span>').appendTo(e);g.click(function(){if(c.teams.length>1)return c.teams=c.teams.slice(0,c.teams.length/2),C(d)})}if(1===c.results.length&&c.teams.length>1){var h=a('<span class="doubleElimination">de</span>').appendTo(e);h.click(function(){if(c.teams.length>1&&c.results.length<3)return c.results.push([],[]),C(d)})}else if(3===c.results.length&&c.teams.length>1){var h=a('<span class="singleElimination">se</span>').appendTo(e);h.click(function(){if(3===c.results.length)return c.results=c.results.slice(0,1),C(d)})}}var t,u=function(){function a(a){if(this.val=a,void 0===this.val)throw new Error("Option cannot contain undefined")}return a.of=function(b){return new a(b)},a.prototype.get=function(){if(null===this.val)throw new Error("Trying to get() empty Option");return this.val},a.prototype.orElse=function(a){return null===this.val?a:this.val},a.prototype.orElseGet=function(a){return null===this.val?a():this.val},a.prototype.map=function(b){return null===this.val?this:new a(b(this.val))},a.prototype.toNull=function(){return null===this.val?null:this.val},a.prototype.isEmpty=function(){return null===this.val},a}();!function(a){a[a.TBD=0]="TBD",a[a.BYE=1]="BYE"}(t||(t={}));var v=function(){function a(a,b,c,d,e){this.source=a,this.name=b,this.id=c,this.idx=d,this.score=e}return a.prototype.emptyBranch=function(){if(!this.name.isEmpty())return t.TBD;try{return this.source().emptyBranch()}catch(a){if(a instanceof c)return t.BYE;throw new Error("Unexpected exception type")}},a}(),w=function(){function a(a,b){this.a=a,this.b=b}return a.teamsInResultOrder=function(a){var c=a.a.name.isEmpty(),d=a.b.name.isEmpty();if(d&&!c)return a.b.emptyBranch()===t.BYE?[a.a,a.b]:[];if(c&&!d)return a.a.emptyBranch()===t.BYE?[a.b,a.a]:[];if(b(a.a.score)&&b(a.b.score)){if(a.a.score>a.b.score)return[a.a,a.b];if(a.a.score<a.b.score)return[a.b,a.a]}return[]},a.emptyTeam=function(a){return new v(a,u.of(null),-1,-1,null)},a.prototype.winner=function(){return a.teamsInResultOrder(this)[0]||a.emptyTeam(this.a.source)},a.prototype.loser=function(){return a.teamsInResultOrder(this)[1]||a.emptyTeam(this.a.source)},a}(),x=function(a,b){return function(){return[{source:function(){return new v(function(){throw new c},a[b][0],0,2*b,null)}},{source:function(){return new v(function(){throw new c},a[b][1],1,2*b+1,null)}}]}},y=function(a,b){return function(c){c.css("top",""),c.css("position","absolute"),b?c.css("top",a.el.height()/2-c.height()/2+"px"):c.css("bottom",-c.height()/2+"px")}},z=function(a,b,c,d,e,f){return function(){if(e%2===0&&0===f)return[{source:a.round(0).match(2*d).loser},{source:a.round(0).match(2*d+1).loser}];var g=f%2===0?c-d-1:d;return[{source:b.round(2*f).match(d).winner},{source:a.round(f+1).match(g).loser}]}},A=function(a,b){return function(){return a.css("top",b.el.height()/2-a.height()/2+"px")}},B=function(){function b(b,c,d,e,f,g,h){this.bracket=b,this.previousRound=c,this.roundIdx=d,this._results=e,this.doRenderCb=f,this.mkMatch=g,this.isFirstBracket=h,this.roundCon=a('<div class="round"></div>'),this.matches=[]}return Object.defineProperty(b.prototype,"el",{get:function(){return this.roundCon},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"id",{get:function(){return this.roundIdx},enumerable:!0,configurable:!0}),b.prototype.addMatch=function(a,b){var c=this.matches.length,d=null!==a?a():[{source:this.bracket.round(this.roundIdx-1).match(2*c).winner},{source:this.bracket.round(this.roundIdx-1).match(2*c+1).winner}],e=d[0].source,f=d[1].source,g=new w(new v(e,e().name,0,e().idx,null),new v(f,f().name,1,f().idx,null)),h=this.mkMatch(this,g,c,this._results.map(function(a){return void 0===a[c]?null:a[c].length>=2?a[c]:[null,null]}),b,this.isFirstBracket);return this.matches.push(h),h},b.prototype.match=function(a){return this.matches[a]},b.prototype.prev=function(){return this.previousRound},b.prototype.size=function(){return this.matches.length},b.prototype.render=function(){this.roundCon.empty(),("function"!=typeof this.doRenderCb||this.doRenderCb())&&(this.roundCon.appendTo(this.bracket.el),this.matches.forEach(function(a){return a.render()}))},b.prototype.results=function(){return this.matches.reduce(function(a,b){return a.concat([b.results()])},[])},b}(),C=function(c){function f(a){v=0,y.render(),z&&z.render(),A&&!c.skipGrandFinalComeback&&A.render(),g(B,y,A),a&&(x.results[0]=y.results(),z&&(x.results[1]=z.results()),A&&!c.skipGrandFinalComeback&&(x.results[2]=A.results()),c.save&&c.save(r(x),c.userData))}function j(d,e,g,h,i,j){var k=v,l=a('<div class="score" data-resultid="result-'+k+'"></div>'),m=g.name.isEmpty()||h.name.isEmpty()||!i?"--":null!==g.score&&b(g.score)?g.score:"--";l.text(m),v+=1;var n=g.name.orElseGet(function(){var a=g.emptyBranch();if(a===t.BYE)return"BYE";if(a===t.TBD)return"TBD";throw new Error("Unexpected branch type "+a)}),o=a('<div class="team"></div>'),p=a('<div class="label"></div>').appendTo(o);return 0===d&&o.attr("data-resultid","team-"+k),c.decorator.render(p,n,m),b(g.idx)&&o.attr("data-teamid",g.idx),g.name.isEmpty()?o.addClass("na"):e.winner().name===g.name?o.addClass("win"):e.loser().name===g.name&&o.addClass("lose"),o.append(l),(!g.name.isEmpty()||g.name.isEmpty()&&0===d&&j)&&"function"==typeof c.save&&(p.addClass("editable"),p.click(function(){function b(){function h(h,i){c.init.teams[~~(g.idx/2)][g.idx%2]=u.of(h||null),f(!0),e.click(b);var j=c.el.find(".team[data-teamid="+(g.idx+1)+"] div.label:first");j.length&&i===!0&&0===d&&a(j).click()}e.unbind(),c.decorator.edit(e,g.name.toNull(),h)}var e=a(this);b()}),g.name.isEmpty()||h.name.isEmpty()||!i||(l.addClass("editable"),l.click(function(){function c(){d.unbind();var e=b(g.score)?d.text():"0",h=a('<input type="text">');h.val(e),d.empty().append(h),h.focus().select(),h.keydown(function(c){b(a(this).val())?a(this).removeClass("error"):a(this).addClass("error");var d=c.keyCode||c.which;if(9===d||13===d||27===d){if(c.preventDefault(),a(this).blur(),27===d)return;var e=B.find("div.score[data-resultid=result-"+(k+1)+"]");e&&e.click()}}),h.blur(function(){var a=h.val();a&&b(a)||b(g.score)?a&&b(a)||!b(g.score)||(a=g.score):a="0",d.html(a),b(a)&&(g.score=parseInt(a,10),f(!0)),d.click(c)})}var d=a(this);c()}))),o}function k(d,e,f,g,h,i){var k=a('<div class="match"></div>'),l=a('<div class="teamContainer"></div>'),m=null,n=null;if(!c.save){var o=g.map(function(a){return a.length<3?null:a[2]}).toNull();c.onMatchHover&&l.hover(function(){c.onMatchHover(o,!0)},function(){c.onMatchHover(o,!1)}),c.onMatchClick&&l.click(function(){c.onMatchClick(o)})}return e.a.name=e.a.source().name,e.b.name=e.b.source().name,e.a.score=g.map(function(a){return a[0]}).toNull(),e.b.score=g.map(function(a){return a[1]}).toNull(),e.a.name&&e.b.name||!b(e.a.score)&&!b(e.b.score)||(console.log("ERROR IN SCORE DATA: "+e.a.source().name+": "+e.a.score+", "+e.b.source().name+": "+e.b.score),e.a.score=e.b.score=null),{el:k,id:f,round:function(){return d},connectorCb:function(a){m=a},connect:function(a){var b,c,d=l.height()/4,e=k.height()/2;if(a&&null!==a){var g=a(l,this);if(null===g)return;b=g.shift,c=g.height}else f%2===0?0===this.winner().id?(b=d,c=e):1===this.winner().id?(b=3*d,c=e-2*d):(b=2*d,c=e-d):0===this.winner().id?(b=3*-d,c=-e+2*d):1===this.winner().id?(b=-d,c=-e):(b=2*-d,c=-e+d);l.append(p(c,b,l,w))},winner:function(){return e.winner()},loser:function(){return e.loser()},first:function(){return e.a},second:function(){return e.b},setAlignCb:function(a){n=a},render:function(){k.empty(),l.empty(),e.a.name=e.a.source().name,e.b.name=e.b.source().name,e.a.idx=e.a.source().idx,e.b.idx=e.b.source().idx;var a=e.a.name.isEmpty()&&e.b.name.isEmpty();a?l.addClass("np"):e.winner().name?l.removeClass("np"):l.addClass("np");var b=!e.a.name.isEmpty()&&!e.b.name.isEmpty();l.append(j(d.id,e,e.a,e.b,b,i)),l.append(j(d.id,e,e.b,e.a,b,i)),k.appendTo(d.el),k.append(l),this.el.css("height",d.bracket.el.height()/d.size()+"px"),l.css("top",this.el.height()/2-l.height()/2+"px"),null!==n&&n(l);var c="function"==typeof h&&h(this);c||this.connect(m)},results:function(){var a=e.a.name.isEmpty()||e.b.name.isEmpty();return a&&(e.a.score=e.b.score=null),[e.a.score,e.b.score]}}}var v,w="lr"===c.dir?"right":"left";if(!c)throw Error("Options not set");if(!c.el)throw Error("Invalid jQuery object as container");if(!c.init&&!c.save)throw Error("No bracket data or save callback given");if(void 0===c.userData&&(c.userData=null),!(!c.decorator||c.decorator.edit&&c.decorator.render))throw Error("Invalid decorator input");c.decorator||(c.decorator={edit:h,render:i});var x;c.init||(c.init={teams:[[u.of(null),u.of(null)]],results:[]}),x=c.init;var y,z,A,B=a('<div class="jQBracket '+c.dir+'"></div>').appendTo(c.el.empty()),C=e(x.results,4-d(x.results));x.results=C;var D=C.length<=1;c.skipSecondaryFinal&&D&&a.error("skipSecondaryFinal setting is viable only in double elimination mode"),c.save&&s(B,x,c);var E,F,G;D?F=a('<div class="bracket"></div>').appendTo(B):(c.skipGrandFinalComeback||(E=a('<div class="finals"></div>').appendTo(B)),F=a('<div class="bracket"></div>').appendTo(B),G=a('<div class="loserBracket"></div>').appendTo(B));var H=64*x.teams.length;F.css("height",H),D&&x.teams.length<=2&&!c.skipConsolationRound&&B.css("height",H+40),G&&G.css("height",F.height()/2);var I=q(x.teams.length,D,c.skipGrandFinalComeback);return c.save?B.css("width",140*I+40):B.css("width",140*I+10),y=o(F,u.of(C[0]||null),k,!0),D||(z=o(G,u.of(C[1]||null),k,!1),c.skipGrandFinalComeback||(A=o(E,u.of(C[2]||null),k,!1))),l(y,x.teams,D,c.skipConsolationRound,c.skipGrandFinalComeback&&!D),D||(m(y,z,x.teams.length,c.skipGrandFinalComeback),c.skipGrandFinalComeback||n(A,y,z,c.skipSecondaryFinal,c.skipConsolationRound,B)),f(!1),{data:function(){return r(c.init)}}},D={init:function(b){var c=a.extend(!0,{},b),d=this;c.el=this,c.save&&(c.onMatchClick||c.onMatchHover)&&a.error("Match callbacks may not be passed in edit mode (in conjunction with save callback)"),c.dir=c.dir||"lr",c.init.teams=c.init.teams&&0!==c.init.teams.length?c.init.teams:[[null,null]],c.init.teams=c.init.teams.map(function(a){return a.map(function(a){return u.of(a)})}),c.skipConsolationRound=c.skipConsolationRound||!1,c.skipSecondaryFinal=c.skipSecondaryFinal||!1,"lr"!==c.dir&&"rl"!==c.dir&&a.error('Direction must be either: "lr" or "rl"');var e=C(c);return a(this).data("bracket",{target:d,obj:e}),e},data:function(){var b=a(this).data("bracket");return b.obj.data()}};a.fn.bracket=function(b){return D[b]?D[b].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof b&&b?void a.error("Method "+b+" does not exist on jQuery.bracket"):D.init.apply(this,arguments)}}(jQuery);